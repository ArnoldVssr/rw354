import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;

class ThreadLocalDemo2
{
	public static void main (String [] args)
	{
		/*MyThread mt1 = new MyThread ("A");
      mt1.start();
      /*MyThread mt2 = new MyThread ("B");
      MyThread mt3 = new MyThread ("C");
      mt1.start ();
      mt2.start ();
      mt3.start ();*/
	}
}
class MyThread extends Thread
{
	//private MyClient test;
	//private static ThreadLocal tl = new ThreadLocal ();
	private static boolean connected = true;
	MyThread (String name)
	{
		super (name);
		//this.test = a;
	}
	public void run ()
	{
		//System.out.println(MyClitest);
		String inputName = "";
		String choice = "";
		BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));

		while(connected)
		{
			try 
			{
				connected = false;
				synchronized(test.lock)
				{
					System.out.println("User Connected.");
					System.out.print("Username: ");
					inputName = reader.readLine();
					test.user.setName(inputName);
					test.readBusy = false;	
					test.lock.notify();
				}
				while(!test.readBusy)
				{
					MyThread.sleep(200);
				}
				
				while (test.notUnique)
				{
					//System.out.println(test.notUnique);
					synchronized(test.lock)
					{
						System.out.println("TLD2 says username was: " + test.user.getName());
						System.out.println("Name already taken.");
						System.out.print("Username: ");
						inputName = reader.readLine();
						test.user.setName(inputName);
						System.out.println("TLD2 says username is: " + test.user.getName());
						test.readBusy = false;
						test.lock.notify();
					}
					while(!test.readBusy)
					{
						MyThread.sleep(5000);
					}
				}
				
				while(!choice.equalsIgnoreCase("bye"))
				{
					synchronized(test.lock)
					{
						System.out.println("What you want?");
						choice = reader.readLine();
						if (choice.equalsIgnoreCase("whisper"))
	                	{
	                		System.out.print("User: ");
	                		String whipsUser = reader.readLine();
	                		System.out.println("Message: ");
	                		String whispMessage = reader.readLine();
	                		test.tm = new Message(whipsUser, whispMessage);
	                	}
						test.readBusy = false;
						test.lock.notify();
					}
					while(!test.readBusy)
					{
						MyThread.sleep(200);
					}
				}
			} 
			catch (IOException e) 
			{
				e.printStackTrace();
			} 
			catch (InterruptedException e) 
			{
				e.printStackTrace();
			}
		}
	}
}